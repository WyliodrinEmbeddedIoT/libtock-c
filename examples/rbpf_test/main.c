#include <stdio.h>
#include <gpio.h>
#include <tock.h>
#include <timer.h>

#define DRIVER_NUM_LATENCY 0x10001

// char prog[] = {
//         0x71, 0x12, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
//         0x73, 0x21, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00,
//         0xb7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//         0x95, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
//   };
  char prog[] = {
          0x71, 0x14, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 
          0x57, 0x04, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 
          0x71, 0x12, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 
          0xbf, 0x23, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
          0x57, 0x03, 0x00, 0x00, 0xcf, 0x00, 0x00, 0x00, 
          0x47, 0x03, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 
          0x15, 0x04, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x47, 0x02, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 
          0xbf, 0x23, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x73, 0x31, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,
          0xb7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x95, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  };

int main(void) 
{
  // Checking maximum program size
  syscall_return_t res = command(DRIVER_NUM_LATENCY, 0, 0, 0);
  if (res.type == TOCK_SYSCALL_SUCCESS_U32) {
    printf("Maximum stack size is: %ld\n", res.data[0]);
  } else {
    printf("Capsule failure!\n");
    return tock_status_to_returncode (res.data[0]);
  }

  // Sharing the program buffer
  allow_ro_return_t aval = allow_readonly(DRIVER_NUM_LATENCY, 1, (const void*) prog, 96);
  if (aval.status != TOCK_STATUSCODE_SUCCESS) {
    printf("Allow error!\n");
    return tock_allow_ro_return_to_returncode(aval);
  }

  // Make input
  res = command(DRIVER_NUM_LATENCY, 1, 34, PullUp);
  if (res.type != TOCK_SYSCALL_SUCCESS) {
    printf("Capsule failure!\n");
    return tock_status_to_returncode (res.data[0]);
  }

  // Enable interrupt
  res = command(DRIVER_NUM_LATENCY, 2, 34, 0);
  if (res.type != TOCK_SYSCALL_SUCCESS) {
  	printf("Capsule failure!\n");
    return tock_status_to_returncode (res.data[0]);
  }
  return 0;
}